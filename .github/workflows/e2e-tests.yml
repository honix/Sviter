name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Create artifact directories
        run: |
          mkdir -p frontend/playwright-report frontend/test-results

      - name: Build images with cache
        uses: docker/bake-action@v5
        with:
          files: tests/docker-compose.e2e.yml
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
          load: true

      - name: Run E2E tests
        run: |
          docker compose -f tests/docker-compose.e2e.yml up --abort-on-container-exit --exit-code-from playwright

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: |
          docker compose -f tests/docker-compose.e2e.yml down --volumes --remove-orphans
